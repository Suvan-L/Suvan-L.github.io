<!doctype html>



  


<html class="theme-next mist use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
    
  
  <link href="https://cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.min.css" rel="stylesheet" type="text/css" />




  
  
  
  

  

  

  

  

  

  






  

<link href="https://cdn.bootcss.com/font-awesome/4.6.2/css/font-awesome.min.css" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.1" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Oracle," />





  <link rel="alternate" href="/atom.xml" title="Suvan" type="application/atom+xml" />




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.1" />






<meta name="description" content="目录 编写匿名块程序，实现根据商品名称进行模糊查询，输出该商品的其他基本信息 根据“双11促销活动”策略，编写一个匿名块程序，将原来折扣为0的，调整为0.9，将原来折扣为1的调整为0.95，其他的调整为0.92，之后输出“目前9折的商品有XX件， 92折的商品有XX件， 95折的商品有XX件” 优化第1题，写成存储过程 优化第2题,简单的方式解决 银行转账，将程序改造为存储过程5.2 另一种版本">
<meta name="keywords" content="Oracle">
<meta property="og:type" content="article">
<meta property="og:title" content="Oracle_PLSQL 习题">
<meta property="og:url" content="http://suvan-l.github.io/2016/06/04/Oracle_PLSQL 习题/index.html">
<meta property="og:site_name" content="Suvan">
<meta property="og:description" content="目录 编写匿名块程序，实现根据商品名称进行模糊查询，输出该商品的其他基本信息 根据“双11促销活动”策略，编写一个匿名块程序，将原来折扣为0的，调整为0.9，将原来折扣为1的调整为0.95，其他的调整为0.92，之后输出“目前9折的商品有XX件， 92折的商品有XX件， 95折的商品有XX件” 优化第1题，写成存储过程 优化第2题,简单的方式解决 银行转账，将程序改造为存储过程5.2 另一种版本">
<meta property="og:locale" content="zh-Hans">
<meta property="og:updated_time" content="2018-01-17T03:43:22.072Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Oracle_PLSQL 习题">
<meta name="twitter:description" content="目录 编写匿名块程序，实现根据商品名称进行模糊查询，输出该商品的其他基本信息 根据“双11促销活动”策略，编写一个匿名块程序，将原来折扣为0的，调整为0.9，将原来折扣为1的调整为0.95，其他的调整为0.92，之后输出“目前9折的商品有XX件， 92折的商品有XX件， 95折的商品有XX件” 优化第1题，写成存储过程 优化第2题,简单的方式解决 银行转账，将程序改造为存储过程5.2 另一种版本">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    sidebar: {"position":"right","display":"always","offset":12,"offset_float":0,"b2t":false,"scrollpercent":false},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://suvan-l.github.io/2016/06/04/Oracle_PLSQL 习题/"/>





  <title>Oracle_PLSQL 习题 | Suvan</title>
  














</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-right page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Suvan</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <h1 class="site-subtitle" itemprop="description">blog</h1>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://suvan-l.github.io/2016/06/04/Oracle_PLSQL 习题/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="刘淑玮">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/uploads/suvan-min.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Suvan">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">Oracle_PLSQL 习题</h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2016-06-04T00:21:43+08:00">
                2016-06-04
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Oracle/" itemprop="url" rel="index">
                    <span itemprop="name">Oracle</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计</span>
                
                <span title="字数统计">
                  7,197
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长</span>
                
                <span title="阅读时长">
                  32
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        <h1 id="目录"><a href="#目录" class="headerlink" title="目录"></a>目录</h1><ol>
<li>编写匿名块程序，实现根据商品名称进行模糊查询，输出该商品的其他基本信息</li>
<li>根据“双11促销活动”策略，编写一个匿名块程序，将原来折扣为0的，调整为0.9，将原来折扣为1的调整为0.95，其他的调整为0.92，之后输出“目前9折的商品有XX件， 92折的商品有XX件， 95折的商品有XX件”</li>
<li>优化第1题，写成存储过程</li>
<li>优化第2题,简单的方式解决</li>
<li>银行转账，将程序改造为存储过程<br>5.2 另一种版本</li>
<li>审核采购表，编写存储过程</li>
<li>编写根据订单单号审核订单的存储过程 </li>
<li>计算税后工资</li>
<li>自动生成采购单号（使用函数）</li>
<li>使用函数实现订单编号的智能编码，规则为：用户Id+yyyymm+XXX(001-999)</li>
<li>在添加订单明细时，用函数实现订单明细中根据商品编号返回商品的单价（商品信息表中）</li>
<li>编写存储过程，实现订单的审核出库</li>
<li>将上面10，11，12合成一个程序包</li>
<li>编写触发器，实现当订单明细发生改变时，调整订单总金额</li>
<li>编写触发器，实现删除订单前，检查是否为2、发货中，3、已完结，如是提醒不能删除</li>
<li>设计一个用于系统商品数据盘点的的表和存储过程</li>
<li>编写存储过程完成借书过程</li>
<li>编写函数实现：借书记录号编码</li>
<li>编写触发器,实现删除前判断</li>
</ol>
<p>以上题目都是针对本人电脑进行的，均经过检验，在<strong>本人电脑</strong>都可以运行使用</p>
<p>电脑配置：</p>
<ul>
<li>Windows 8.1中文版本 64位操作系统，基于X64的处理器</li>
<li>处理器:Intel(R) Core(TM) i5-4200H CPU @ 2.80GHz</li>
<li>安装内存:12.0GB</li>
<li>Oracle 11G</li>
<li>Java 1.8.0_65</li>
<li>Oracle SQL Develper 版本4.0.0.12 工作版本MAIN-12.84</li>
</ul>
<p>目录:</p>
<h2 id="1-编写匿名块程序，实现根据商品名称进行模糊查询，输出该商品的其他基本信息"><a href="#1-编写匿名块程序，实现根据商品名称进行模糊查询，输出该商品的其他基本信息" class="headerlink" title="1. 编写匿名块程序，实现根据商品名称进行模糊查询，输出该商品的其他基本信息"></a>1. 编写匿名块程序，实现根据商品名称进行模糊查询，输出该商品的其他基本信息</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line">SET serveroutput ON;</div><div class="line"></div><div class="line">DECLARE</div><div class="line"> v_one t_goods.gname%type := &apos;&amp;请输入要查询的商品名称&apos;;</div><div class="line"> v_gname t_goods.gname%type;</div><div class="line"> v_goods_all t_goods%rowtype;</div><div class="line"> </div><div class="line">BEGIN</div><div class="line"> dbms_output.put_line(&apos;您输入的关键词为:&apos;||v_one);</div><div class="line"> </div><div class="line"> dbms_output.put_line(&apos;..........正在搜索&apos;);</div><div class="line"> SELECT gname INTO v_gname FROM t_goods </div><div class="line">     WHERE gname LIKE &apos;%&apos;||v_one||&apos;%&apos;;</div><div class="line"> dbms_output.put_line(&apos;..........查询完毕&apos;);</div><div class="line"> </div><div class="line"> dbms_output.put_line(&apos;存在商品:&apos;||v_gname||&apos;----:商品相关信息如下&apos;);</div><div class="line"> SELECT * INTO v_goods_all FROM t_goods WHERE gname = v_gname;</div><div class="line"> </div><div class="line"> dbms_output.put_line</div><div class="line"> (</div><div class="line">   &apos;编号:&apos;||v_goods_all.gid||</div><div class="line">   &apos;名称:&apos;||v_goods_all.gname||</div><div class="line">   &apos;类型:&apos;||v_goods_all.gtid||</div><div class="line">   &apos;价格:&apos;||v_goods_all.gprice||</div><div class="line">   &apos;折扣:&apos;||v_goods_all.gdiscount||</div><div class="line">   &apos;库存:&apos;||v_goods_all.gstocks||</div><div class="line">   &apos;最高库存:&apos;||v_goods_all.gmaxstocks||</div><div class="line">   &apos;最低库存:&apos;||v_goods_all.gminstocks||</div><div class="line">   &apos;备注:&apos;||v_goods_all.gmemo</div><div class="line"> );</div><div class="line"> </div><div class="line">END;</div><div class="line">/</div></pre></td></tr></table></figure>
<hr>
<p><br></p>
<h2 id="2-根据“双11促销活动”策略，编写一个匿名块程序，将原来折扣为0的，调整为0-9，将原来折扣为1的调整为0-95，其他的调整为0-92，之后输出“目前9折的商品有XX件，-92折的商品有XX件，-95折的商品有XX件”"><a href="#2-根据“双11促销活动”策略，编写一个匿名块程序，将原来折扣为0的，调整为0-9，将原来折扣为1的调整为0-95，其他的调整为0-92，之后输出“目前9折的商品有XX件，-92折的商品有XX件，-95折的商品有XX件”" class="headerlink" title="2. 根据“双11促销活动”策略，编写一个匿名块程序，将原来折扣为0的，调整为0.9，将原来折扣为1的调整为0.95，其他的调整为0.92，之后输出“目前9折的商品有XX件， 92折的商品有XX件， 95折的商品有XX件”"></a>2. 根据“双11促销活动”策略，编写一个匿名块程序，将原来折扣为0的，调整为0.9，将原来折扣为1的调整为0.95，其他的调整为0.92，之后输出“目前9折的商品有XX件， 92折的商品有XX件， 95折的商品有XX件”</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line">SET serveroutput ON;</div><div class="line"></div><div class="line">DECLARE</div><div class="line">   v_gdiscount t_goods.gdiscount%type;</div><div class="line">   v_gname t_goods.gname%type;</div><div class="line">   pnum_9 NUMBER := 0;</div><div class="line">   pnum_92 NUMBER := 0;</div><div class="line">   pnum_95 NUMBER := 0;</div><div class="line">   pnum NUMBER := 1;</div><div class="line">   CURSOR cemp is SELECT gdiscount,gname FROM t_goods;</div><div class="line"> </div><div class="line">BEGIN</div><div class="line"> OPEN cemp;</div><div class="line">   LOOP EXIT WHEN cemp%NOTFOUND;  </div><div class="line">     fetch cemp INTO v_gdiscount,v_gname;</div><div class="line">       dbms_output.put_line(&apos;现在是针对第&apos;||pnum||&apos;商品&apos;||v_gname||&apos;进行操作&apos;);</div><div class="line">       dbms_output.put_line(pnum||&apos;号商品&apos;||v_gname||&apos;的折扣是:&apos;||v_gdiscount);</div><div class="line">       </div><div class="line">       IF  v_gdiscount = 100 then UPDATE t_goods SET gdiscount=90 WHERE gname=v_gname;</div><div class="line">         ELSIF v_gdiscount = 10 then UPDATE t_goods SET gdiscount=95 WHERE gname=v_gname;</div><div class="line">         ELSE  UPDATE t_goods SET gdiscount = 92 WHERE gname=v_gname;                                   </div><div class="line">       END IF;</div><div class="line">       </div><div class="line">       </div><div class="line">     pnum := pnum +1;</div><div class="line">   END LOOP;</div><div class="line">   CLOSE cemp;</div><div class="line">   </div><div class="line">   SELECT count(*) INTO pnum_9 FROM t_goods WHERE gdiscount=90 GROUP BY gdiscount;</div><div class="line">   SELECT count(*) INTO pnum_92 FROM t_goods WHERE gdiscount=92 GROUP  BY gdiscount;</div><div class="line">   SELECT count(*) INTO pnum_95 FROM t_goods WHERE gdiscount=95 GROUP  BY gdiscount;</div><div class="line"></div><div class="line">   </div><div class="line">   dbms_output.put_line(&apos;目前9折的商品&apos;||pnum_9||&apos;有件&apos;);</div><div class="line">   dbms_output.put_line(&apos;目前92折的商品&apos;||pnum_92||&apos;有件&apos;);</div><div class="line">   dbms_output.put_line(&apos;目前95折的商品&apos;||pnum_95||&apos;有件&apos;);</div><div class="line">END;</div><div class="line">/</div></pre></td></tr></table></figure>
<hr>
<p><br></p>
<h2 id="3-优化第1题，写成存储过程"><a href="#3-优化第1题，写成存储过程" class="headerlink" title="3. 优化第1题，写成存储过程"></a>3. 优化第1题，写成存储过程</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">SET serveroutput ON;                            </div><div class="line">CREATE OR REPLACE PROCEDURE p_querygoods(i_gname in VARCHAR2 )     --创建存储过程  ,输入in，输出out</div><div class="line">AS</div><div class="line">  v_gid t_goods.gid%type;   --锚定变量</div><div class="line">  v_gname t_goods.gname%type;</div><div class="line">  v_gprice t_goods.gprice%type;</div><div class="line">BEGIN</div><div class="line">  SELECT gid,gname,gprice INTO v_gid,v_gname,v_gprice</div><div class="line">    FROM t_goods</div><div class="line">      WHERE gname LIKE &apos;%&apos;||i_gname||&apos;%&apos;; --绑定变量</div><div class="line">    </div><div class="line">    dbms_output.put_line(v_gid||v_gname||v_gprice);   </div><div class="line">EXCEPTION </div><div class="line">  WHEN no_data_found THEN </div><div class="line">    dbms_output.put_line(&apos;找不到满足条件的数据&apos;);</div><div class="line">  WHEN too_many_rows THEN</div><div class="line">    dbms_output.put_line(&apos;找到过多的数据&apos;);</div><div class="line">END;</div><div class="line">/</div><div class="line">show error;</div><div class="line"></div><div class="line">SET serveroutput ON;</div><div class="line">exec p_querygoods(&apos;com&apos;);  --调用存储过程</div></pre></td></tr></table></figure>
<hr>
<p><br></p>
<h2 id="4-优化第2题-简单的方式解决"><a href="#4-优化第2题-简单的方式解决" class="headerlink" title="4. 优化第2题,简单的方式解决"></a>4. 优化第2题,简单的方式解决</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line">SET serveroutput ON;</div><div class="line">DECLARE</div><div class="line">  v_92 number;</div><div class="line">  v_95 number;</div><div class="line">  v_90 number;</div><div class="line">BEGIN</div><div class="line">  UPDATE t_goods SET gdiscount=92 WHERE gdiscount &lt;&gt; 0 and gdiscount &lt;&gt; 10;</div><div class="line">  v_92 := SQL%rowcount;  --影响了几行</div><div class="line">  UPDATE t_goods SET gdiscount=90 WHERE gdiscount=0;</div><div class="line">  v_90 := SQL%rowcount;</div><div class="line">  UPDATE t_goods SET gdiscount=0.95 WHERE gdiscount=10;</div><div class="line">  v_95 := SQL%rowcount;</div><div class="line">  </div><div class="line">  dbms_output.put_line(&apos;目前9折的商品有&apos;||v_90||&apos;件,92折的商品有&apos;||v_92||&apos;件，95折的商品有&apos;||v_95||&apos;件&apos;);</div><div class="line">  </div><div class="line">  COMMIT;</div><div class="line">  dbms_output.put_line(&apos;修改成功&apos;);</div><div class="line">EXCEPTION</div><div class="line">    WHEN others THEN </div><div class="line">      rollback;</div><div class="line">      dbms_output.put_line(SQLERRM);</div><div class="line">END;</div><div class="line">/</div><div class="line"></div><div class="line"> SHOW error;</div></pre></td></tr></table></figure>
<hr>
<p><br></p>
<h2 id="5-银行转账，将程序改造为存储过程"><a href="#5-银行转账，将程序改造为存储过程" class="headerlink" title="5. 银行转账，将程序改造为存储过程"></a>5. 银行转账，将程序改造为存储过程</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">/*</div><div class="line">  存储过程:p_zhuanzhang</div><div class="line">  功能： 实现转账</div><div class="line">  输入参数:1.i_money : number  转账金额;</div><div class="line">          2.i_out : CHAR  转出的账户;</div><div class="line">          3.i_in :  CHAR  转入的账户;</div><div class="line">  创建人： 创建日期</div><div class="line">  修改人，修改日期...</div><div class="line">  </div><div class="line">*/</div><div class="line">CREATE or REPLACE procedure p_zhuanzhang (i_money NUMBER,i_out CHAR,i_in CHAR)</div><div class="line">AS</div><div class="line">  v_num NUMBER := 0;</div><div class="line">  v_pmoney NUMBER(10,2);</div><div class="line">  e_errorout EXCEPTION;   --自定义的异常</div><div class="line">BEGIN</div><div class="line">    SELECT count(tid) INTO v_num </div><div class="line">      FROM LIQIANG.t_account WHERE tid=i_out;</div><div class="line">    IF vnum =0 THEN      --验证用户是否正确</div><div class="line">      raise e_errorout;  --抛出自定义异常，程序跳到EXCEPTION语句块中</div><div class="line">    END IF;</div><div class="line"></div><div class="line">    --查询转出账户的余额</div><div class="line">    SELECT tmoney INTO v_pmoney</div><div class="line">      FROM LIQIANG.t_account WHERE tid=i_out;</div><div class="line">      </div><div class="line">    IF v_pmoney&lt;i_money THEN </div><div class="line">      dbms_output.put_line(&apos;余额不足，无法进行转账&apos;);</div><div class="line">      RAISE_APPLICATION_ERROR(-20001,&apos;余额不足&apos;);   --抛出异常，自定义编号和提示</div><div class="line">      RETURN;</div><div class="line">    END IF;</div><div class="line">    </div><div class="line">    UPDATE LIQIANG.t_account SET tmoney=tmoney-i_money WHERE tid=i_out;   --i_in用户转账</div><div class="line">    INSERT INTO LIQIANG.t_items(tid1,iid,itype,tid2,imoney)               --添加转账记录</div><div class="line">      VALUES (i_out,seq_ma.nextval,1,i_in,i_money);</div><div class="line">      </div><div class="line">    UPDATE LIQIANG.t_account SET tmoney=tmoney-i_money WHERE tid=i_in;    --i_out用户接收转账</div><div class="line">    INSERT INTO LIQIANG.t_items(tid1,iid,itype,tid2,imoney)               --添加转账记录</div><div class="line">      VALUES (i_in,seq_ma.nextval,2,i_out,i_money);</div><div class="line">      </div><div class="line">      commit;</div><div class="line">      </div><div class="line">EXCEPTION </div><div class="line">  WHEN e_errorout THEN   --捕获自定义异常</div><div class="line">    dbms_output.put_line(&apos;您的转出账户不存在&apos;);</div><div class="line">  WHEN others THEN       --捕获其它异常</div><div class="line">    dbms_output.put_line(&apos;转账失败&apos;||SQLERRM);   </div><div class="line">    rollback;</div><div class="line">END;</div><div class="line">/</div><div class="line"></div><div class="line">show error;   --显示错误信息</div><div class="line"></div><div class="line">SET serveroutput ON;</div><div class="line">execute p_money(1000,&apos;A14210120238&apos;,&apos;LIQIANG&apos;);  ---调用存储过程</div></pre></td></tr></table></figure>
<hr>
<p><br></p>
<h2 id="5-2-另一种版本"><a href="#5-2-另一种版本" class="headerlink" title="5.2 另一种版本"></a>5.2 另一种版本</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div></pre></td><td class="code"><pre><div class="line">SET serveroutput ON;</div><div class="line"></div><div class="line">/*</div><div class="line">存储过程：进行转账</div><div class="line">输入参数：i_out,转出账户，类型为char；i_in,转入账户，类型为char；i_money,转账金额，类型为number</div><div class="line">创建人： 创建日期：</div><div class="line">版本4.0*/</div><div class="line">create or replace procedure p_trans(i_out in char,i_in in char,i_money in number)</div><div class="line">as</div><div class="line"> v_numout number:=0;v_numin number:=0;</div><div class="line"> v_tmoney number(10,2);</div><div class="line"> e_error EXCEPTION;--自定义了一个异常1)</div><div class="line">begin</div><div class="line">  select count(tid) into v_numout  from liqiang.t_account</div><div class="line">     where TID =i_out ;--验证账户是否正确</div><div class="line">  select count(tid) into v_numin  from liqiang.t_account</div><div class="line">     where TID =i_in ;--验证账户是否正确</div><div class="line">  if v_numout&lt;&gt;1 or v_numin&lt;&gt;1 then </div><div class="line">    raise e_error;--抛出自定义的异常2)</div><div class="line">  end if;</div><div class="line">  select tmoney into v_tmoney    from liqiang.t_account</div><div class="line">     where TID =i_out ;</div><div class="line">  if v_tmoney&lt;=i_money then  </div><div class="line">    RAISE_APPLICATION_ERROR(-20001,&apos;您的余额不足&apos;); </div><div class="line">  end if;</div><div class="line">     update liqiang.t_account set TMONEY = TMONEY-i_money </div><div class="line">      where TID =i_out ;</div><div class="line">     insert into liqiang.t_items(iid,tid1,idate,itype,tid2,imoney) </div><div class="line">         values (seq_tiid.nextval,i_out,default,-1,i_in,i_money);</div><div class="line">     update liqiang.t_account set TMONEY = TMONEY+i_money where TID =i_in;</div><div class="line">     insert into liqiang.t_items(iid,tid1,idate,itype,tid2,imoney) </div><div class="line">              values (seq_tiid.nextval,i_in,default,1,i_out,i_money);</div><div class="line">  commit;  </div><div class="line"> exception</div><div class="line">    when e_error then </div><div class="line">      dbms_output.put_line(&apos;您的账户输入不正确&apos;);--捕获自定义的异常3)</div><div class="line">    when others then</div><div class="line">        dbms_output.put_line(&apos;转账失败&apos;||SQLERRM);</div><div class="line">       rollback;</div><div class="line">END; </div><div class="line">/</div><div class="line"> SHOW error;</div></pre></td></tr></table></figure>
<hr>
<p><br></p>
<h2 id="6-审核采购表，编写存储过程"><a href="#6-审核采购表，编写存储过程" class="headerlink" title="6. 审核采购表，编写存储过程"></a>6. 审核采购表，编写存储过程</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div></pre></td><td class="code"><pre><div class="line">/*</div><div class="line">  功能需求:</div><div class="line">    判断此采购单是否已审核</div><div class="line">    将采购单主表的状态修改为已审核 </div><div class="line">    输出一个审核的结果</div><div class="line">    修改对应商品的库存数</div><div class="line">    判断采购的商品入库以后是否溢出</div><div class="line">    对比价格并修改成本价</div><div class="line">    修改对应商品的库存数</div><div class="line">    </div><div class="line">  存储过程:p_checkmainprocure</div><div class="line">  功能： 审核采购信息</div><div class="line">  输入参数:1.i_procureid :CHAR,采购单号;</div><div class="line">  输出参数:1.o_result ：NUMBER,审核结果</div><div class="line">  创建人：...</div><div class="line">  创建日期: ...</div><div class="line">  修改人: ...</div><div class="line">  修改日期: ...</div><div class="line">*/</div><div class="line"></div><div class="line"> --o_result:1：审核成功，-1:单据已经审核,SQLCODE</div><div class="line">CREATE OR REPLACE PROCEDURE p_checkmainprocure(i_pmid in CHAR,</div><div class="line"> o_result out NUMBER) </div><div class="line">AS</div><div class="line">  v_num NUMBER;   --用于计数</div><div class="line">  v_pstate t_main_procure.pstate%type;   --采购状态</div><div class="line">  e_over EXCEPTION;  --自定义异常</div><div class="line">  </div><div class="line">  CURSOR cur_items IS SELECT gid,pinum FROM  --1.定义游标</div><div class="line">    t_procure_items WHERE  pmid= i_pmid;   </div><div class="line">    v_gid t_procure_items.gid%type;       --商品ID</div><div class="line">    v_pinum t_procure_items.pinum%type;   --采购数量</div><div class="line">    v_gstocks t_goods.gstocks%type;       --库存量</div><div class="line">    v_max t_goods.gmaxstocks%type;        --最大库存量</div><div class="line">BEGIN</div><div class="line">  SELECT COUNT(pmid) INTO v_num FROM t_main_procure WHERE pmid=i_pmid;    --查询对应的采购订单</div><div class="line">  IF v_num=0 THEN </div><div class="line">      RAISE_APPLICATION_ERROR(-20001,&apos;单据不存在！&apos;);    --抛出异常，编号-20001，提示信息：&quot;单据不存在！&quot;</div><div class="line">  END IF;</div><div class="line">  </div><div class="line">  SELECT  pstate INTO v_pstate FROM t_main_procure WHERE pmid =i_pmid;   --查询对应的采购状态</div><div class="line">  IF(v_pstate=&apos;2&apos;) THEN       --1、待审核，2、已审核 </div><div class="line">     raise e_over;</div><div class="line">  END IF;</div><div class="line"></div><div class="line">  UPDATE t_main_procure SET pstate=&apos;2&apos; WHERE pmid= i_pmid;   --修改采购状态</div><div class="line"></div><div class="line">  OPEN cur_items; --2.打开游标</div><div class="line">    FETCH cur_items INTO v_gid,v_pinum;   --3.提取游标(第1行数据)</div><div class="line">    IF(cur_items%notfound) THEN     --判断对应的采购主表是否有采购明细表</div><div class="line">      raise_application_error(-20003, &apos;主表没有明细&apos;);</div><div class="line">    END IF;</div><div class="line">    </div><div class="line">    WHILE(cur_items%found) </div><div class="line">      Loop</div><div class="line">        SELECT gstocks, gmaxstocks  INTO v_gstocks,v_max FROM t_goods WHERE gid=v_gid; --查询库存量，和最大库存量</div><div class="line">        IF(v_max&gt;v_gstocks+v_pinum) THEN     --判断库存量+采购数量是否&gt;最大库存量，商品入库是否溢出</div><div class="line">          UPDATE t_goods SET gstocks=gstocks+v_pinum WHERE gid =v_gid;</div><div class="line">          ELSE </div><div class="line">            raise_application_error(-20002, &apos;已超过该商品的最大存库量&apos;);</div><div class="line">        END IF;</div><div class="line">        </div><div class="line">        FETCH cur_items INTO v_gid,v_pinum; --3_2.提取下一个游标</div><div class="line">      END LOOP;</div><div class="line">      </div><div class="line">  CLOSE  cur_items; --4.关闭游标 </div><div class="line">  </div><div class="line">   commit;</div><div class="line">   o_result:=1;   --输出参数返回1，审核成功</div><div class="line">EXCEPTION</div><div class="line">    WHEN e_over THEN o_result:=-1;  --返回输出参数</div><div class="line">    WHEN others THEN </div><div class="line">      dbms_output.put_line(&apos;出现其他异常&apos;||SQLERRM);</div><div class="line">      o_result := SQLCODE;</div><div class="line">      rollback;</div><div class="line">      </div><div class="line">END;</div><div class="line">/</div><div class="line">show error;  --显示错误信息</div><div class="line"></div><div class="line"></div><div class="line">set serveroutput on</div><div class="line">exec p_checkmainprocure(&apos;i002&apos;);--没有输出参数的调用</div><div class="line"></div><div class="line">DECLARE  ---带有输出参数的调用</div><div class="line">  v_result NUMBER;</div><div class="line">BEGIN</div><div class="line">  p_checkmainprocure(&apos;i002&apos;,v_result) ;</div><div class="line">  </div><div class="line">  IF v_result=1 THEN </div><div class="line">     dbms_output.put_line(&apos;审核成功！&apos;);</div><div class="line">  ELSIF</div><div class="line">    v_result=-1 then</div><div class="line">    dbms_output.put_line(&apos;采购单已经审核，不能重复审核！&apos;);</div><div class="line">  ELSE</div><div class="line">    dbms_output.put_line(&apos;审核发生错误，错误代码为&apos;||v_result);</div><div class="line"> END IF;  </div><div class="line"> </div><div class="line">END;</div></pre></td></tr></table></figure>
<hr>
<p><br></p>
<h2 id="7-编写根据订单单号审核订单的存储过程"><a href="#7-编写根据订单单号审核订单的存储过程" class="headerlink" title="7. 编写根据订单单号审核订单的存储过程"></a>7. 编写根据订单单号审核订单的存储过程</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">/*</div><div class="line">  编写根据订单单号审核订单的存储过程 </div><div class="line">    功能需求：</div><div class="line">      1.根据订单号判断是否存在该订单</div><div class="line">          如果没有，则报错，不存在该订单</div><div class="line">          如果有，则进行2</div><div class="line">      2.判断该订单是否拥有订单明细表(t_order_items)</div><div class="line">          如果没有，则报错，不存在订单明细表</div><div class="line">          如果有，则进行4</div><div class="line">      3.判断该订单的订单状态</div><div class="line">        如果是发货中，已完结，取消，则退出程序；</div><div class="line">        如果审核中，则进行4</div><div class="line">      4.进行审核</div><div class="line">         4.1判断商品信息表(t_goods)中是否拥有对应的商品ID</div><div class="line">            .如果没有，则报错，不存在对应商品</div><div class="line">            .如果有的，则进行4.2</div><div class="line">         4.2判断商品信息表(t_goods)中库存量是否满足订单数量</div><div class="line">            .如果不满足，则报错，库存量不足</div><div class="line">            .如果满足，则进行4.3</div><div class="line">         4.3判断订单主表(t_main_order)中订单总金额</div><div class="line">            是否符合（订单数量X （商品标价x商品折扣））应付的钱</div><div class="line">            .高了，则报错，付钱过多</div><div class="line">            .低了，则报错，金额不足</div><div class="line">            .刚好，则进行4.4</div><div class="line">         4.4修改商品信息表（t_goods）的库存量</div><div class="line">             将库存量修改为（库存量-订单数量）,并且4.5</div><div class="line">         4.5审核完毕，修改订单状态</div><div class="line">       5.输出审核结果</div><div class="line">       </div><div class="line">    必要性与可行性:</div><div class="line">      1.必要,可行</div><div class="line">      2.必要,可行</div><div class="line">      3.必要，可行</div><div class="line">      4.</div><div class="line">         4.1 必要，可行</div><div class="line">         4.2 必要，可行</div><div class="line">         4.3 必要，可行</div><div class="line">         4.4 必要，可行</div><div class="line">         4.5 必要，可行</div><div class="line">      5.必要，可行</div><div class="line">      </div><div class="line">     存储过程:p_auditindent</div><div class="line">        功能： 审核订单</div><div class="line">         输入参数:1.i_omid :CHAR,订单号;</div><div class="line">         输出参数:1.o_result ：NUMBER,审核结果;</div><div class="line">         创建人：刘淑玮</div><div class="line">         创建日期: 2016.5.16</div><div class="line">*/</div><div class="line"></div><div class="line">CREATE OR REPLACE PROCEDURE p_auditindent(i_omid IN CHAR,o_result OUT NUMBER)</div><div class="line">AS</div><div class="line">  v_num NUMBER;</div><div class="line">  v_totalmoney NUMBER(10,2);  --（订单数量X （商品标价x商品折扣））</div><div class="line">  v_ostate t_main_order.ostate%type;  --储存订单状态</div><div class="line">                                      --1、审核中，2、发货中，3、已完结，4、取消</div><div class="line">  v_oamount t_main_order.oamount%type;  --订单总金额</div><div class="line">  </div><div class="line">  v_gid_O t_order_items.gid%type;   --储存订单上的商品ID</div><div class="line">  v_onum t_order_items.onum%type;    --储存订单的数量</div><div class="line"></div><div class="line">  </div><div class="line">  CURSOR c_items IS SELECT omid FROM t_order_items WHERE omid=i_omid;  --定义光标，是否有对应的明细表</div><div class="line">  CURSOR c_goods IS SELECT gid,gprice,gdiscount,gstocks FROM t_goods; --定义光标，查询商品ID，商品标价，折扣，库存量</div><div class="line">  v_gid_G t_goods.gid%type;             --储存商品ID</div><div class="line">  v_gprice t_goods.gid%type;            --储存商品标价</div><div class="line">  v_gdiscount t_goods.gdiscount%type;   --储存商品折扣</div><div class="line">  v_gstocks t_goods.gstocks%type;        --储存商品库存量</div><div class="line">  </div><div class="line">  e_no_items EXCEPTION; --没有明细表</div><div class="line">  </div><div class="line">BEGIN</div><div class="line">      ---1.根据订单号判断是否存在该订单</div><div class="line">      SELECT COUNT(omid) INTO v_num FROM t_main_order WHERE omid=i_omid;</div><div class="line">      IF v_num=0 THEN</div><div class="line">         raise_application_error(-10011,&apos;不存在该订单&apos;);</div><div class="line">      END IF;</div><div class="line">      ---2.判断该订单是否拥有订单明细表(t_order_items)</div><div class="line">      OPEN c_items;</div><div class="line">        IF C_items%notfound THEN RAISE e_no_items;</div><div class="line">        END IF;</div><div class="line">      CLOSE c_items;</div><div class="line">        </div><div class="line">      ---3.判断该订单的订单状态，不为1（审核中）的时候报错，并且退出程序</div><div class="line">      SELECT ostate INTO v_ostate FROM t_main_order WHERE omid=i_omid;</div><div class="line">      IF v_ostate=2 THEN  </div><div class="line">            o_result:=-30031;</div><div class="line">            raise_application_error(-30031,&apos;商品发货中...&apos;);</div><div class="line">      ELSIF v_ostate=3 THEN</div><div class="line">            o_result:=-30032;</div><div class="line">            raise_application_error(-30032,&apos;商品已完结&apos;);</div><div class="line">      ELSIF v_ostate=4 THEN</div><div class="line">            o_result:=-30033;</div><div class="line">            raise_application_error(-30033,&apos;商品已取消&apos;);</div><div class="line">      END IF;</div><div class="line">      </div><div class="line">      </div><div class="line">      --4.进行审核</div><div class="line">          SELECT gid,onum INTO v_gid_O,v_onum FROM t_order_items WHERE omid=i_omid;  --查询订单的商品ID，订单数量，并储存</div><div class="line">          SELECT oamount INTO v_oamount FROM t_main_order WHERE omid=i_omid ;         --查询订单的总金额，并储存</div><div class="line">      </div><div class="line">      --4.1判断商品信息表(t_goods)中是否拥有对应的商品ID</div><div class="line">      OPEN c_goods;</div><div class="line">         LOOP </div><div class="line">            FETCH c_goods INTO v_gid_G,v_gprice,v_gdiscount,v_gstocks;</div><div class="line">          </div><div class="line">            EXIT WHEN v_gid_O=v_gid_G;   --遇到满足条件则退出循环，向下执行</div><div class="line">            IF c_goods%notfound THEN</div><div class="line">              o_result:=-30041;</div><div class="line">              raise_application_error(-30041,&apos;抱歉，仓库中没有与订单对应商品，即将退出程序...&apos;);</div><div class="line">            END IF;</div><div class="line">         END LOOP;</div><div class="line">         </div><div class="line">         --4.2判断商品信息表(t_goods)中库存量是否满足订单数量</div><div class="line">          IF v_gstocks &lt; v_onum THEN</div><div class="line">            o_result:=-30042;</div><div class="line">            raise_application_error(-30042,&apos;仓库库存量不足.&apos;);</div><div class="line">          END IF;</div><div class="line">          </div><div class="line">          --4.3判断订单主表(t_main_order)中订单总金额</div><div class="line">           -- 是否符合（订单数量X （商品标价x商品折扣））应付的钱</div><div class="line">                   </div><div class="line">           v_totalmoney := v_onum*(v_gprice*v_gdiscount);  --进行计算</div><div class="line">            IF  v_oamount &gt; v_totalmoney  THEN</div><div class="line">               o_result:= -300431;</div><div class="line">               raise_application_error(-300431,&apos;订单金额过多&apos;);</div><div class="line">            ELSIF v_oamount &lt; v_totalmoney THEN </div><div class="line">               o_result:= -300431;</div><div class="line">               raise_application_error(-300431,&apos;订单金额过少&apos;);</div><div class="line">            END IF;</div><div class="line">            </div><div class="line">      CLOSE c_goods;</div><div class="line"></div><div class="line">         --4.4修改商品信息表（t_goods）的库存量，将库存量修改为（库存量-订单数量）,并且进行4.5</div><div class="line">             UPDATE t_goods SET gstocks=gstocks-v_onum WHERE gid=v_gid_G;</div><div class="line">             </div><div class="line">         --4.5审核完毕，修改订单状态</div><div class="line">             UPDATE t_main_order SET ostate=3 WHERE omid=i_omid ;   --将订单状态修改为已完结</div><div class="line">      </div><div class="line">        --5.，提交操作，输出结果，输出审核结果</div><div class="line">      commit;</div><div class="line">      o_result:=1;  --输出参数为1，订单审核成功</div><div class="line">EXCEPTION</div><div class="line">    WHEN e_no_items THEN dbms_output.put_line(&apos;没有明细表&apos;);</div><div class="line">      return;   </div><div class="line">    WHEN others THEN dbms_output.put_line(&apos;捕获其他异常，错误信息为&apos;||SQLERRM);</div><div class="line">      rollback;</div><div class="line">END;</div><div class="line">/</div><div class="line">show error;  --显示错误信息</div><div class="line"></div><div class="line"></div><div class="line">SET serveroutput ON;</div><div class="line">DECLARE</div><div class="line">  v_result NUMBER;</div><div class="line">BEGIN</div><div class="line">  p_auditindent(&apos;1&apos;,v_result);   --调用带参的存储过程</div><div class="line">  </div><div class="line">  IF v_result=1 THEN</div><div class="line">    dbms_output.put_line(&apos;审核成功&apos;);</div><div class="line">    ELSE </div><div class="line">      dbms_output.put_line(&apos;审核发生错误，错误代码为&apos;||v_result);</div><div class="line">  END IF;</div><div class="line">END;</div></pre></td></tr></table></figure>
<hr>
<p><br></p>
<h2 id="8-计算税后工资"><a href="#8-计算税后工资" class="headerlink" title="8. 计算税后工资"></a>8. 计算税后工资</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"></div><div class="line">          ///////不完整，仅供参考</div><div class="line">/*</div><div class="line">工资个税的计算公式为：应纳税额</div><div class="line">输入：yfgz</div><div class="line">*/</div><div class="line">--输出参数</div><div class="line">--函数只能返回一个值</div><div class="line">create or replace function f_gerensuodesui(yfgz in number) return number --返回值类型 名字f_开头</div><div class="line">as</div><div class="line">ynse number:=0;--应纳税额</div><div class="line">v_yjs number;</div><div class="line">begin</div><div class="line">v_yjs:=yfgz-3500;</div><div class="line">  if v_yjs&lt;=0 then</div><div class="line">    ynse:=0;</div><div class="line">    elsif v_yjs&lt;=1500 then</div><div class="line">    ynse:=v_yjs*0.03;</div><div class="line">  elsif v_yjs &lt;=4500 then</div><div class="line">    ynse:=v_yjs*0.1-105;</div><div class="line">  elsif v_yjs&lt;=9000 then</div><div class="line">    ynse:=v_yjs*0.2-555;</div><div class="line">  elsif v_yjs&lt;=35000 then</div><div class="line">    ynse:=v_yjs*0.25-1005;</div><div class="line">  elsif v_yjs&lt;=35000 then</div><div class="line">    ynse:=v_yjs*0.25-1005;</div><div class="line">  elsif v_yjs&lt;=55000 then</div><div class="line">    ynse:=v_yjs*0.3-2755;</div><div class="line">  elsif v_yjs&lt;=80000 then</div><div class="line">    ynse:=v_yjs*0.35-5505;</div><div class="line">  elsif v_yjs&gt;80000 then</div><div class="line">    ynse:=v_yjs*0.45-13505;</div><div class="line">  end if;</div><div class="line">   return ynse;</div><div class="line">exception</div><div class="line">    when others then</div><div class="line">   return -1;</div><div class="line">end;</div><div class="line">/</div><div class="line">show error</div><div class="line"></div><div class="line">select f_gerensuodesui(6000) from dual;</div></pre></td></tr></table></figure>
<hr>
<p><br></p>
<h2 id="9-自动生成采购单号（使用函数）"><a href="#9-自动生成采购单号（使用函数）" class="headerlink" title="9. 自动生成采购单号（使用函数）"></a>9. 自动生成采购单号（使用函数）</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line">/*</div><div class="line">功能需求:</div><div class="line">        采购单号的编码规则为“PYYYYMMXXXXX”，其中“P”为采购单的前缀表示，</div><div class="line">        “YYYYMM”表示采购单生成的年月，“XXXXX”为每月的流水号码。</div><div class="line">        比如2016年6月3号生成的本月的第20张的采购单号为：“P20160600020”。</div><div class="line">        类似地要求订单号的编码规则为“OYYYYMMXXXXX”，请编写函数实现。</div><div class="line">*/</div><div class="line"></div><div class="line">CREATE OR REPLACE FUNCTION f_createpmid RETURN VARCHAR2</div><div class="line">AS</div><div class="line">  v_pmid VARCHAR2(12);</div><div class="line">  v_maxomid t_main_procure.omid%type;</div><div class="line">BEGIN</div><div class="line">   v_pmid:=&apos;P&apos;;</div><div class="line">   v_pmid:=v_pmid||to_char(sysdate,&apos;yyyymm&apos;);</div><div class="line">   SELECT max(omid) INTO v_maxomid FROM t_main_procure    --查询当月最大的采购单</div><div class="line">      WHERE to_char(pdate,&apos;yyyymm&apos;)=to_char(sysdate,&apos;yyyymm&apos;);</div><div class="line">    IF v_maxomid IS NULL THEN</div><div class="line">      v_pmid:=v_pmid||&apos;00001&apos;;</div><div class="line">    ELSE</div><div class="line">      v_pmid:=v_pmid||trim(to_char(to_number(substr(v_maxomid,8,5))+1,&apos;00000&apos;));  ---得到流水号</div><div class="line">    END IF;</div><div class="line">    RETURN v_pmid;</div><div class="line">EXCEPTION</div><div class="line">  WHEN others THEN</div><div class="line">      RETURN -1;</div><div class="line"></div><div class="line">END;</div><div class="line">/</div><div class="line">SHOW error;</div><div class="line"></div><div class="line"></div><div class="line">SELECT f_createpmid pmid from dual;   --尝试调用</div><div class="line">INSERT INTO t_main_procure(omid,pstate) VALUES (f_createpmid,&apos;1&apos;);</div></pre></td></tr></table></figure>
<hr>
<p><br></p>
<h2 id="10-使用函数实现订单编号的智能编码，规则为：用户Id-yyyymm-XXX-001-999"><a href="#10-使用函数实现订单编号的智能编码，规则为：用户Id-yyyymm-XXX-001-999" class="headerlink" title="10. 使用函数实现订单编号的智能编码，规则为：用户Id+yyyymm+XXX(001-999)"></a>10. 使用函数实现订单编号的智能编码，规则为：用户Id+yyyymm+XXX(001-999)</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line">/*</div><div class="line">  一：</div><div class="line">    功能需求：使用函数实现订单编号的智能编码，规则为：用户Id+yyyymm+XXX(001-999).</div><div class="line">    函数名：fun_number</div><div class="line">    返回值：CHAR 订单编号的智能编码</div><div class="line">    创建时间：2016.6.1</div><div class="line">*/</div><div class="line">CREATE OR REPLACE FUNCTION fun_number RETURN CHAR</div><div class="line">AS</div><div class="line">  v_number CHAR(12);   --存储智能编码</div><div class="line">  v_omid t_main_order.omid%type;     --存储订单编号</div><div class="line">BEGIN</div><div class="line">  SELECT  MAX(omid)INTO v_omid FROM  t_main_order   --查找最大的订单编号</div><div class="line">    WHERE omid LIKE &apos;038%&apos;;</div><div class="line">  IF v_omid IS NULL THEN       --如果ID+yyyymm+XXX，这种类型的订单编号</div><div class="line">      v_number :=&apos;038&apos;||trim(to_char(sysdate,&apos;yyyymm&apos;))||&apos;001&apos;;</div><div class="line">  ELSIF trim(substr(v_omid,10,3))=&apos;999&apos; THEN                       --订单编号流水号达到999</div><div class="line">      raise_application_error(-10012,&apos;该用户的订单达到饱和，无法再次添加..&apos;);</div><div class="line">    ELSE                          --将之前表中订单编号的流水号最大的号码+1，再格式化存入订单主表中</div><div class="line">      v_number :=&apos;038&apos;||trim(to_char(sysdate,&apos;yyyymm&apos;))||trim(to_char(to_number(substr(v_omid,10,3))+1,&apos;000&apos;));</div><div class="line">  END IF;</div><div class="line">  RETURN v_number;</div><div class="line">EXCEPTION</div><div class="line">  WHEN others THEN </div><div class="line">    dbms_output.put_line(&apos;捕获其他异常，错误信息为&apos;||SQLERRM);</div><div class="line">      rollback;</div><div class="line">END fun_number;</div><div class="line">/</div><div class="line">show ERROR;</div><div class="line"></div><div class="line">--测试</div><div class="line">SELECT fun_number FROM dual;</div><div class="line">INSERT INTO t_main_order(omid,uiid,odate,ostate) VALUES (fun_number,&apos;37&apos;,sysdate,&apos;1&apos;);</div></pre></td></tr></table></figure>
<hr>
<p><br></p>
<h2 id="11-在添加订单明细时，用函数实现订单明细中根据商品编号返回商品的单价（商品信息表中）"><a href="#11-在添加订单明细时，用函数实现订单明细中根据商品编号返回商品的单价（商品信息表中）" class="headerlink" title="11. 在添加订单明细时，用函数实现订单明细中根据商品编号返回商品的单价（商品信息表中）"></a>11. 在添加订单明细时，用函数实现订单明细中根据商品编号返回商品的单价（商品信息表中）</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div></pre></td><td class="code"><pre><div class="line">/*</div><div class="line">  二：</div><div class="line">    功能需求：在添加订单明细时，用函数实现订单明细中根据商品编号返回商品的单价（商品信息表中）</div><div class="line">    函数名称：fun_returnprice</div><div class="line">    输入参数：in_gid: CHAR 商品编号</div><div class="line">    返回值: NUMBER  商品价格</div><div class="line">    创建时间：2016.6.1</div><div class="line">*/</div><div class="line">CREATE OR REPLACE FUNCTION fun_returnprice(in_gid IN CHAR) RETURN NUMBER</div><div class="line">AS</div><div class="line">  v_ifgid NUMBER;  --存储是对应的商品记录数</div><div class="line">  v_gprice t_goods.gprice%type;  --存储商品价格</div><div class="line"></div><div class="line">  no_date_found EXCEPTION;</div><div class="line">BEGIN</div><div class="line">  --1.判断是否存在对应商品</div><div class="line">  SELECT COUNT(gid) INTO v_ifgid FROM t_goods</div><div class="line">       WHERE gid LIKE &apos;%&apos;||substr(in_gid,2,4)||&apos;%&apos;; </div><div class="line"></div><div class="line">    IF v_ifgid=0 THEN </div><div class="line">      raise no_date_found;</div><div class="line">    END IF;</div><div class="line">  --2.根据查询商品编号，查询对应的商品价格</div><div class="line">  SELECT gprice INTO v_gprice FROM t_goods    </div><div class="line">      WHERE gid LIKE &apos;%&apos;||substr(in_gid,2,4)||&apos;%&apos;; </div><div class="line"></div><div class="line">  RETURN v_gprice;</div><div class="line">  </div><div class="line">EXCEPTION </div><div class="line">  WHEN no_date_found THEN</div><div class="line">    dbms_output.put_line(in_gid||&apos;该订单编号，不存在对应的商品&apos;);</div><div class="line">    return -1;</div><div class="line">  WHEN others THEN </div><div class="line">    dbms_output.put_line(&apos;捕获其他异常，错误信息为&apos;||SQLERRM);</div><div class="line">    return -2;</div><div class="line">END fun_returnprice;</div><div class="line">/</div><div class="line">show ERROR;</div><div class="line"></div><div class="line">--测试</div><div class="line">SELECT  fun_returnprice(&apos;q0001&apos;) FROM dual;</div></pre></td></tr></table></figure>
<hr>
<p><br></p>
<h2 id="12-编写存储过程，实现订单的审核出库"><a href="#12-编写存储过程，实现订单的审核出库" class="headerlink" title="12. 编写存储过程，实现订单的审核出库"></a>12. 编写存储过程，实现订单的审核出库</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div></pre></td><td class="code"><pre><div class="line">/*</div><div class="line">  三,</div><div class="line">    功能需求：编写存储过程，实现订单的审核出库</div><div class="line">    存储过程:p_auditindent</div><div class="line">    功能审核订单</div><div class="line">         输入参数:1.i_omid :CHAR,订单号;</div><div class="line">         输出参数:1.o_result ：NUMBER,审核结果;</div><div class="line">    创建时间：2016.6.1</div><div class="line">        </div><div class="line">*/</div><div class="line">CREATE OR REPLACE PROCEDURE p_auditindent(i_omid IN CHAR,o_result OUT NUMBER)</div><div class="line">AS</div><div class="line">  v_totalmoney NUMBER(10,2);  --（订单数量X （商品标价x商品折扣））</div><div class="line">  v_ostate t_main_order.ostate%type;  --储存订单状态</div><div class="line">                                      --1、审核中，2、发货中，3、已完结，4、取消</div><div class="line">  </div><div class="line">  v_gid_O t_order_items.gid%type;   --储存订单上的商品ID</div><div class="line">  v_onum t_order_items.onum%type;    --储存订单的数量</div><div class="line"></div><div class="line">  CURSOR c_goods IS SELECT gid,gstocks FROM t_goods; --定义光标，查询商品库存量</div><div class="line">  v_gid_G t_goods.gid%type;             --储存商品ID</div><div class="line">  v_gstocks t_goods.gstocks%type;        --储存商品库存量</div><div class="line">  </div><div class="line">BEGIN</div><div class="line">      --1.判断该订单的订单状态，不为2（发货中）的时候报错，并且退出程序</div><div class="line">      SELECT ostate INTO v_ostate FROM t_main_order WHERE omid=i_omid;</div><div class="line">      IF v_ostate=1 THEN  </div><div class="line">            o_result:=-30031;</div><div class="line">            raise_application_error(-30031,&apos;商品审核中&apos;);</div><div class="line">      ELSIF v_ostate=3 THEN</div><div class="line">            o_result:=-30032;</div><div class="line">            raise_application_error(-30032,&apos;商品已完结&apos;);</div><div class="line">      ELSIF v_ostate=4 THEN</div><div class="line">            o_result:=-30033;</div><div class="line">            raise_application_error(-30033,&apos;商品已取消&apos;);</div><div class="line">      END IF;</div><div class="line">      </div><div class="line">      --2.进行出库审核</div><div class="line">          SELECT gid,onum INTO v_gid_O,v_onum FROM t_order_items WHERE omid=i_omid;  --查询订单的商品ID和订单数量，并储存</div><div class="line">      </div><div class="line">        --2.1提取订单所中商品id，所对应商品信息表中相应商品ID和库存量</div><div class="line">        OPEN c_goods;   --开启光标</div><div class="line">           LOOP</div><div class="line">              FETCH c_goods INTO v_gid_G,v_gstocks; </div><div class="line">              EXIT WHEN v_gid_O=v_gid_G;  --退出条件</div><div class="line">              </div><div class="line">              IF c_goods%notfound THEN</div><div class="line">                o_result:=-300411;</div><div class="line">                  raise_application_error(-30041,&apos;抱歉，仓库中没有与订单对应商品...&apos;);</div><div class="line">              END IF;</div><div class="line">            END LOOP;</div><div class="line">         </div><div class="line">      CLOSE c_goods;  --关闭光标</div><div class="line"></div><div class="line">         --2.2判断商品信息表(t_goods)中库存量是否满足订单数量</div><div class="line">            IF v_onum &gt; v_gstocks THEN</div><div class="line">              o_result:=-30042;</div><div class="line">              raise_application_error(-30042,&apos;仓库库存量不足，无法出库&apos;);</div><div class="line">            END IF;  </div><div class="line"></div><div class="line">          --2.2出库成功，，修改商品信息表（t_goods）的库存量，将库存量修改为（库存量-订单数量）</div><div class="line">             UPDATE t_goods SET gstocks=gstocks-v_onum WHERE gid=v_gid_G;</div><div class="line">             </div><div class="line">         --2.3订单审核出库完毕，修改订单状态</div><div class="line">             UPDATE t_main_order SET ostate=3 WHERE omid=i_omid ;   --将订单状态修改为已完结</div><div class="line">      </div><div class="line">        --3.提交操作，输出结果，输出审核结果</div><div class="line">      commit;</div><div class="line">      o_result:=1;  --输出参数为1，订单出库审核成功</div><div class="line">EXCEPTION</div><div class="line">    WHEN others THEN dbms_output.put_line(&apos;捕获其他异常，错误信息为&apos;||SQLERRM);</div><div class="line">    rollback;</div><div class="line">END;</div><div class="line">/</div><div class="line">show error;  --显示错误信息</div><div class="line"></div><div class="line"></div><div class="line">SET serveroutput ON;</div><div class="line">DECLARE</div><div class="line">  v_result NUMBER;</div><div class="line">BEGIN</div><div class="line">  p_auditindent(&apos;1&apos;,v_result);   --调用带参的存储过程</div><div class="line">  </div><div class="line">  IF v_result=1 THEN</div><div class="line">    dbms_output.put_line(&apos;审核出库成功&apos;);</div><div class="line">    ELSE </div><div class="line">      dbms_output.put_line(&apos;审核发生错误，错误代码为&apos;||v_result);</div><div class="line">  END IF;</div><div class="line"></div><div class="line">END;</div></pre></td></tr></table></figure>
<hr>
<p><br></p>
<h2 id="13-将上面10，11，12合成一个程序包"><a href="#13-将上面10，11，12合成一个程序包" class="headerlink" title="13. 将上面10，11，12合成一个程序包"></a>13. 将上面10，11，12合成一个程序包</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div></pre></td><td class="code"><pre><div class="line">/*</div><div class="line">  程序包规范：</div><div class="line">    程序包名:pack_checkorder</div><div class="line">    公有函数:</div><div class="line">      1.fun_number</div><div class="line">      2.fun_returnprice</div><div class="line">    公有存储过程</div><div class="line">    p_auditiondent</div><div class="line">*/</div><div class="line">CREATE OR REPLACE PACKAGE pack_checkorder </div><div class="line">AS</div><div class="line">  --函数</div><div class="line">  FUNCTION fun_number RETURN CHAR;  </div><div class="line">  FUNCTION fun_returnprice(in_gid IN CHAR) RETURN NUMBER;</div><div class="line">  </div><div class="line">  --存储过程</div><div class="line">  PROCEDURE p_auditindent(i_omid IN CHAR,o_result OUT NUMBER);</div><div class="line">END pack_checkorder;</div><div class="line"></div><div class="line">/</div><div class="line">/*</div><div class="line">  程序包主体</div><div class="line">*/</div><div class="line">CREATE OR REPLACE PACKAGE BODY pack_checkorder</div><div class="line">AS</div><div class="line">---fun_number函数</div><div class="line">FUNCTION fun_number RETURN CHAR</div><div class="line">AS</div><div class="line">  v_number CHAR(12);   --存储智能编码</div><div class="line">  v_omid t_main_order.omid%type;     --存储订单编号</div><div class="line">BEGIN</div><div class="line">  SELECT  MAX(omid)INTO v_omid FROM  t_main_order   --查找最大的订单编号</div><div class="line">    WHERE omid LIKE &apos;038%&apos;;</div><div class="line">  IF v_omid IS NULL THEN       --如果ID+yyyymm+XXX，这种类型的订单编号</div><div class="line">      v_number :=&apos;038&apos;||trim(to_char(sysdate,&apos;yyyymm&apos;))||&apos;001&apos;;</div><div class="line">  ELSIF trim(substr(v_omid,10,3))=&apos;999&apos; THEN                       --订单编号流水号达到999</div><div class="line">      raise_application_error(-10012,&apos;该用户的订单达到饱和，无法再次添加..&apos;);</div><div class="line">    ELSE                          --将之前表中订单编号的流水号最大的号码+1，再格式化存入订单主表中</div><div class="line">      v_number :=&apos;038&apos;||trim(to_char(sysdate,&apos;yyyymm&apos;))||trim(to_char(to_number(substr(v_omid,10,3))+1,&apos;000&apos;));</div><div class="line">  END IF;</div><div class="line">  RETURN v_number;</div><div class="line">EXCEPTION</div><div class="line">  WHEN others THEN </div><div class="line">    dbms_output.put_line(&apos;捕获其他异常，错误信息为&apos;||SQLERRM);</div><div class="line">      rollback;</div><div class="line">END fun_number;</div><div class="line"></div><div class="line">--fun_returnprice函数</div><div class="line">FUNCTION fun_returnprice(in_gid IN CHAR) RETURN NUMBER</div><div class="line">AS</div><div class="line">  v_ifgid NUMBER;  --存储是对应的商品记录数</div><div class="line">  v_gprice t_goods.gprice%type;  --存储商品价格</div><div class="line"></div><div class="line">  no_date_found EXCEPTION;</div><div class="line">BEGIN</div><div class="line">  --1.判断是否存在对应商品</div><div class="line">  SELECT COUNT(gid) INTO v_ifgid FROM t_goods</div><div class="line">       WHERE gid LIKE &apos;%&apos;||substr(in_gid,2,4)||&apos;%&apos;; </div><div class="line"></div><div class="line">    IF v_ifgid=0 THEN </div><div class="line">      raise no_date_found;</div><div class="line">    END IF;</div><div class="line">  --2.根据查询商品编号，查询对应的商品价格</div><div class="line">  SELECT gprice INTO v_gprice FROM t_goods    </div><div class="line">      WHERE gid LIKE &apos;%&apos;||substr(in_gid,2,4)||&apos;%&apos;; </div><div class="line"></div><div class="line">  RETURN v_gprice;</div><div class="line">  </div><div class="line">EXCEPTION </div><div class="line">  WHEN no_date_found THEN</div><div class="line">    dbms_output.put_line(in_gid||&apos;该订单编号，不存在对应的商品&apos;);</div><div class="line">    return -1;</div><div class="line">  WHEN others THEN </div><div class="line">    dbms_output.put_line(&apos;捕获其他异常，错误信息为&apos;||SQLERRM);</div><div class="line">    return -2;</div><div class="line">END fun_returnprice;</div><div class="line"></div><div class="line">--p_auditindent存储过程</div><div class="line">PROCEDURE p_auditindent(i_omid IN CHAR,o_result OUT NUMBER)</div><div class="line">AS</div><div class="line">  v_totalmoney NUMBER(10,2);  --（订单数量X （商品标价x商品折扣））</div><div class="line">  v_ostate t_main_order.ostate%type;  --储存订单状态</div><div class="line">                                      --1、审核中，2、发货中，3、已完结，4、取消</div><div class="line">  </div><div class="line">  v_gid_O t_order_items.gid%type;   --储存订单上的商品ID</div><div class="line">  v_onum t_order_items.onum%type;    --储存订单的数量</div><div class="line"></div><div class="line">  CURSOR c_goods IS SELECT gid,gstocks FROM t_goods; --定义光标，查询商品库存量</div><div class="line">  v_gid_G t_goods.gid%type;             --储存商品ID</div><div class="line">  v_gstocks t_goods.gstocks%type;        --储存商品库存量</div><div class="line">  </div><div class="line">BEGIN</div><div class="line">      --1.判断该订单的订单状态，不为2（发货中）的时候报错，并且退出程序</div><div class="line">      SELECT ostate INTO v_ostate FROM t_main_order WHERE omid=i_omid;</div><div class="line">      IF v_ostate=1 THEN  </div><div class="line">            o_result:=-30031;</div><div class="line">            raise_application_error(-30031,&apos;商品审核中&apos;);</div><div class="line">      ELSIF v_ostate=3 THEN</div><div class="line">            o_result:=-30032;</div><div class="line">            raise_application_error(-30032,&apos;商品已完结&apos;);</div><div class="line">      ELSIF v_ostate=4 THEN</div><div class="line">            o_result:=-30033;</div><div class="line">            raise_application_error(-30033,&apos;商品已取消&apos;);</div><div class="line">      END IF;</div><div class="line">      </div><div class="line">      --2.进行出库审核</div><div class="line">          SELECT gid,onum INTO v_gid_O,v_onum FROM t_order_items WHERE omid=i_omid;  --查询订单的商品ID和订单数量，并储存</div><div class="line">      </div><div class="line">        --2.1提取订单所中商品id，所对应商品信息表中相应商品ID和库存量</div><div class="line">        OPEN c_goods;   --开启光标</div><div class="line">           LOOP</div><div class="line">              FETCH c_goods INTO v_gid_G,v_gstocks; </div><div class="line">              EXIT WHEN v_gid_O=v_gid_G;  --退出条件</div><div class="line">              </div><div class="line">              IF c_goods%notfound THEN</div><div class="line">                o_result:=-300411;</div><div class="line">                  raise_application_error(-30041,&apos;抱歉，仓库中没有与订单对应商品...&apos;);</div><div class="line">              END IF;</div><div class="line">            END LOOP;</div><div class="line">         </div><div class="line">      CLOSE c_goods;  --关闭光标</div><div class="line"></div><div class="line">         --2.2判断商品信息表(t_goods)中库存量是否满足订单数量</div><div class="line">            IF v_onum &gt; v_gstocks THEN</div><div class="line">              o_result:=-30042;</div><div class="line">              raise_application_error(-30042,&apos;仓库库存量不足，无法出库&apos;);</div><div class="line">            END IF;  </div><div class="line"></div><div class="line">          --2.2出库成功，，修改商品信息表（t_goods）的库存量，将库存量修改为（库存量-订单数量）</div><div class="line">             UPDATE t_goods SET gstocks=gstocks-v_onum WHERE gid=v_gid_G;</div><div class="line">             </div><div class="line">         --2.3订单审核出库完毕，修改订单状态</div><div class="line">             UPDATE t_main_order SET ostate=3 WHERE omid=i_omid ;   --将订单状态修改为已完结</div><div class="line">      </div><div class="line">        --3.提交操作，输出结果，输出审核结果</div><div class="line">      commit;</div><div class="line">      o_result:=1;  --输出参数为1，订单出库审核成功</div><div class="line">EXCEPTION</div><div class="line">    WHEN others THEN dbms_output.put_line(&apos;捕获其他异常，错误信息为&apos;||SQLERRM);</div><div class="line">    rollback;</div><div class="line">END;</div><div class="line"></div><div class="line">END  pack_checkorder;</div><div class="line">/</div><div class="line">show ERROR;</div></pre></td></tr></table></figure>
<hr>
<p><br></p>
<h2 id="14-编写触发器，实现当订单明细发生改变时，调整订单总金额"><a href="#14-编写触发器，实现当订单明细发生改变时，调整订单总金额" class="headerlink" title="14. 编写触发器，实现当订单明细发生改变时，调整订单总金额"></a>14. 编写触发器，实现当订单明细发生改变时，调整订单总金额</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">/*</div><div class="line">  功能需求：编写触发器，实现当订单明细发生改变时，调整订单总金额</div><div class="line">  触发器:tri_adjustoamount</div><div class="line">*/</div><div class="line">CREATE OR REPLACE TRIGGER tri_adjustoamount</div><div class="line">  AFTER INSERT OR DELETE OR UPDATE</div><div class="line">  ON t_order_items</div><div class="line">  FOR EACH ROW</div><div class="line">BEGIN</div><div class="line">  IF inserting THEN</div><div class="line">    UPDATE t_main_order </div><div class="line">        SET oamount =nvl(oamount,0)+:new.oprice * :new.onum WHERE omid=:new.omid;</div><div class="line">  ELSIF deleting THEN</div><div class="line">    UPDATE t_main_order</div><div class="line">        SET oamount=oamount - :old.oprice * :old.onum WHERE omid=:old.omid;</div><div class="line">  ELSIF updating THEN</div><div class="line">    UPDATE t_main_order</div><div class="line">        SET oamount=oamount - :old.oprice * :old.onum +:new.oprice * :new.onum;</div><div class="line">  END IF;</div><div class="line">END tri_adjustoamount;</div><div class="line">/</div><div class="line">show ERROR;</div></pre></td></tr></table></figure>
<hr>
<p><br></p>
<h2 id="15-编写触发器，实现删除订单前，检查是否为2、发货中，3、已完结，如是提醒不能删除"><a href="#15-编写触发器，实现删除订单前，检查是否为2、发货中，3、已完结，如是提醒不能删除" class="headerlink" title="15. 编写触发器，实现删除订单前，检查是否为2、发货中，3、已完结，如是提醒不能删除"></a>15. 编写触发器，实现删除订单前，检查是否为2、发货中，3、已完结，如是提醒不能删除</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">/*</div><div class="line">  功能需求：编写触发器，实现删除订单前，检查是否为2、发货中，3、已完结，如是提醒不能删除</div><div class="line">  触发器:tri_checkostate</div><div class="line">*/</div><div class="line">CREATE OR REPLACE TRIGGER tri_checkostate </div><div class="line">  BEFORE DELETE </div><div class="line">  ON t_main_order</div><div class="line">  FOR EACH ROW</div><div class="line">BEGIN</div><div class="line">  IF :old.ostate IN (&apos;2&apos;,&apos;3&apos;) THEN</div><div class="line">    raise_application_error(-20000,:old.omid||&apos;订单不能删除&apos;);</div><div class="line">  END IF;</div><div class="line">END tri_checkostate;</div><div class="line">/</div><div class="line">show ERROR;</div></pre></td></tr></table></figure>
<hr>
<p><br></p>
<h2 id="16-设计一个用于系统商品数据盘点的的表和存储过程"><a href="#16-设计一个用于系统商品数据盘点的的表和存储过程" class="headerlink" title="16. 设计一个用于系统商品数据盘点的的表和存储过程"></a>16. 设计一个用于系统商品数据盘点的的表和存储过程</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div></pre></td><td class="code"><pre><div class="line">请你设计一个用于系统商品数据盘点的的 表（盘点时间，商品编号，类型（损耗/结余），数量）和存储过程，</div><div class="line">总公式为：商品的库存量=商品的总采购量-商品的总销售量，</div><div class="line">如有少，添加一条损耗记录，如有多，添加一条结余记录。</div><div class="line"></div><div class="line"></div><div class="line">---查询用户所对应的表空间</div><div class="line">DESC dba_users;</div><div class="line">SELECT username,default_tablespace FROM dba_users;</div><div class="line"></div><div class="line">/*</div><div class="line">  设计系统商品数据盘点的表</div><div class="line">  表名： t_goods_date</div><div class="line">  字段：</div><div class="line">    dateid: NUMBER(10)  数据id，自动递增</div><div class="line">    checktime: DATE  盘点时间</div><div class="line">    gid: CHAR(6) </div><div class="line">    datetype: CHAR(1) 1-损耗，2，结余</div><div class="line">*/</div><div class="line">CREATE TABLE  t_goods_date(</div><div class="line">  deteid NUMBER(10) PRIMARY KEY,</div><div class="line">  checktime DATE DEFAULT SYSDATE,</div><div class="line">  gid CHAR(6) REFERENCES t_goods(gid),</div><div class="line">  detetype CHAR(1) check(detetype in(&apos;1&apos;,&apos;2&apos;)) NOT NULL</div><div class="line">)TABLESPACE tpshopping</div><div class="line">PCTUSED 30  --默认10，数据块使用空间参数</div><div class="line">PCTFREE 20;  --默认40数据块自由空间参数 ，两个加起来做好不要超过100</div><div class="line"></div><div class="line">--创建自动增长序列序列</div><div class="line">CREATE SEQUENCE seq_goodsdate</div><div class="line">START with 1</div><div class="line">INCREMENT BY  1</div><div class="line">MAXVALUE 99999999</div><div class="line">MINVALUE 1</div><div class="line">NOCACHE;</div><div class="line"></div><div class="line">--创建触发器实现自动增长</div><div class="line">CREATE OR REPLACE TRIGGER tri_seq_insert</div><div class="line">  BEFORE INSERT ON t_goods_date</div><div class="line">  FOR EACH ROW</div><div class="line">    BEGIN</div><div class="line">      SELECT seq_goodsdate.nextval INTO :new.gid FROM dual;</div><div class="line">    END;</div><div class="line">    /</div><div class="line">show ERROR;</div><div class="line"></div><div class="line">/*</div><div class="line">  存储过程:p_goodsdate</div><div class="line">功能</div><div class="line">    实现判断损耗，结余</div><div class="line">    总公式为：商品的库存量=商品的总采购量-商品的总销售量，</div><div class="line">         如有少，添加一条损耗记录，如有多，添加一条结余记录。</div><div class="line">    输入参数，i_gid:CHAR(6) 商品ID</div><div class="line">  创建人：刘淑玮</div><div class="line">*/</div><div class="line">CREATE OR REPLACE PROCEDURE p_goodsdate(i_gid IN CHAR)</div><div class="line">AS</div><div class="line">  v_gstocks t_goods.gstocks%type;  --存储当前商品库存量</div><div class="line">  </div><div class="line">  v_pinum t_procure_items.pinum%type;  --存储上的总采购量</div><div class="line">  v_onum t_order_items.onum%type;  --存储商品的总销售量</div><div class="line">  </div><div class="line">  insert_table VARCHAR(200);  --添加语句</div><div class="line">BEGIN</div><div class="line">  SELECT gstocks INTO v_gstocks FROM t_goods WHERE gid=i_gid;</div><div class="line">  SELECT pinum INTO v_pinum FROM t_procure_items WHERE gid=i_gid;</div><div class="line">  SELECT onum INTO v_onum FROM t_order_items WHERE gid=i_gid;</div><div class="line">  </div><div class="line">  IF v_gstocks&lt;(v_pinum-v_onum) THEN</div><div class="line">      insert_table:=&apos;INSERT INTO t_goods_date(gid,detetype) VALUES (&apos;||i_gid||&apos;1&apos;||&apos;)&apos;;</div><div class="line">      EXECUTE IMMEDIATE insert_table;</div><div class="line">    ELSIF v_gstocks&gt;(v_pinum-v_onum) THEN</div><div class="line">      insert_table:=&apos;INSERT INTO t_goods_date(gid,detetype) VALUES (&apos;||i_gid||&apos;2&apos;||&apos;)&apos;;</div><div class="line">      EXECUTE IMMEDIATE insert_table;</div><div class="line">  END IF;</div><div class="line">  </div><div class="line">END;</div><div class="line">/</div><div class="line">show ERROR;</div></pre></td></tr></table></figure>
<hr>
<p><br></p>
<h2 id="17-编写存储过程完成借书过程"><a href="#17-编写存储过程完成借书过程" class="headerlink" title="17. 编写存储过程完成借书过程"></a>17. 编写存储过程完成借书过程</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">CREATE OR REPLACE PROCEDURE p_238vkw</div><div class="line">    (i_stunum IN VARCHAR2,i_boid IN VARCHAR2,o_result OUT NUMBER)</div><div class="line">AS</div><div class="line">    v_A14210120238 student.A14210120238%type;  --读者类型与可借数量</div><div class="line">    v_boloan  book.boloan%type;     ---图书id</div><div class="line">BEGIN</div><div class="line"></div><div class="line">    SELECT A14210120238 INTO v_A14210120238 FROM student WHERE stnum=i_stunum;</div><div class="line">    SELECT boloan INTO v_boloan FROM book WHERE boloan=i_boid;  </div><div class="line">          </div><div class="line">   IF v_A14210120238&gt;0 and v_boloan&gt;0 THEN  --读者可借数量&gt;0  图书可接数量&gt;0</div><div class="line">      o_result :=1;</div><div class="line">   ELSE</div><div class="line">      o_result:=-1;</div><div class="line">    END IF;</div><div class="line">EXCEPTION </div><div class="line">  WHEN others THEN  </div><div class="line">      dbms_output.put_line(&apos;出现其他异常&apos;||SQLERRM);</div><div class="line">      o_result :=-1;</div><div class="line">END;</div><div class="line">/</div><div class="line">show ERROR;</div></pre></td></tr></table></figure>
<hr>
<p><br></p>
<h2 id="18-编写函数实现：借书记录号编码"><a href="#18-编写函数实现：借书记录号编码" class="headerlink" title="18. 编写函数实现：借书记录号编码"></a>18. 编写函数实现：借书记录号编码</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line">/*</div><div class="line">   函数：f_238fpu</div><div class="line">   功能：  </div><div class="line">        编写函数实现：借书记录号编码，</div><div class="line">        yymm+读者编号后三位+三位流水号，</div><div class="line">        并添加一条记录调用此函数实现</div><div class="line">   输入参数:i_sbonamenum VARCHAR2 读者编号</div><div class="line">   返回值： VARCHAR2</div><div class="line">   创建人：刘淑玮</div><div class="line">   创建日期：2016.6.16</div><div class="line"></div><div class="line">*/</div><div class="line">CREATE OR REPLACE FUNCTION f_238fpu(i_sbonamenum IN VARCHAR2) RETURN VARCHAR2</div><div class="line">AS </div><div class="line">  v_number VARCHAR(10);  --智能生成的编号</div><div class="line">  </div><div class="line">  v_sbonum sbook.sbonum%type;  --查询是否存在智能编号</div><div class="line">BEGIN</div><div class="line">  v_number:=trim(substr(i_sbonamenum,2,3));</div><div class="line">  SELECT max(sbonum) INTO v_sbonum FROM sbook WHERE sbonum LIKE &apos;%&apos;||v_number||&apos;%&apos;;</div><div class="line">  IF v_sbonum IS NULL THEN       </div><div class="line">      v_number :=trim(to_char(sysdate,&apos;yymm&apos;))||v_number||&apos;001&apos;;</div><div class="line">    ELSE                  </div><div class="line">      v_number :=trim(to_char(sysdate,&apos;yymm&apos;))||v_number||trim(to_char(to_number(substr(v_sbonum,8,3))+1,&apos;000&apos;));</div><div class="line">  END IF;</div><div class="line">  RETURN v_number;</div><div class="line">EXCEPTION</div><div class="line">  WHEN others THEN </div><div class="line">    dbms_output.put_line(&apos;捕获其他异常，错误信息为&apos;||SQLERRM);</div><div class="line">      rollback;</div><div class="line">END;</div><div class="line">/</div><div class="line">show ERROR;</div><div class="line"></div><div class="line"></div><div class="line">----测试</div><div class="line">INSERT INTO sbook(sbonum,sboid,sbonamenum) VALUES (f_238fpu(&apos;A241&apos;),&apos;003&apos;,&apos;A241&apos;);</div></pre></td></tr></table></figure>
<hr>
<p><br></p>
<h2 id="19-编写触发器-实现删除前判断"><a href="#19-编写触发器-实现删除前判断" class="headerlink" title="19. 编写触发器,实现删除前判断"></a>19. 编写触发器,实现删除前判断</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">CREATE OR REPLACE TRIGGER tr_238poy</div><div class="line">  BEFORE DELETE </div><div class="line">  ON sbook</div><div class="line">  FOR EACH ROW</div><div class="line">BEGIN</div><div class="line">  IF :old.sbolasttime IS NULL THEN   --如果实际归还时间为空，则说明未归还</div><div class="line">      raise_application_error(-20000,:old.sbolasttime||&apos;借书记录不能删除&apos;);</div><div class="line">  END IF;</div><div class="line">END;</div><div class="line">/</div><div class="line">show ERROR;</div></pre></td></tr></table></figure>

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/Oracle/" rel="tag"># Oracle</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2016/06/02/SQLServer_错误记录/" rel="next" title="SQLServer_错误记录">
                <i class="fa fa-chevron-left"></i> SQLServer_错误记录
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2016/06/27/Ecplise_快捷键整理/" rel="prev" title="Eclipse_快捷键整理">
                Eclipse_快捷键整理 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
        <!-- JiaThis Button BEGIN -->
<div class="jiathis_style">
  <a class="jiathis_button_tsina"></a>
  <a class="jiathis_button_tqq"></a>
  <a class="jiathis_button_weixin"></a>
  <a class="jiathis_button_cqq"></a>
  <a class="jiathis_button_douban"></a>
  <a class="jiathis_button_renren"></a>
  <a class="jiathis_button_qzone"></a>
  <a class="jiathis_button_kaixin001"></a>
  <a class="jiathis_button_copy"></a>
  <a href="http://www.jiathis.com/share" class="jiathis jiathis_txt jiathis_separator jtico jtico_jiathis" target="_blank"></a>
  <a class="jiathis_counter_style"></a>
</div>
<script type="text/javascript" >
  var jiathis_config={
    hideMore:false
  }
</script>
<script type="text/javascript" src="http://v3.jiathis.com/code/jia.js" charset="utf-8"></script>
<!-- JiaThis Button END -->

      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/uploads/suvan-min.jpg"
               alt="刘淑玮" />
          <p class="site-author-name" itemprop="name">刘淑玮</p>
           
              <p class="site-description motion-element" itemprop="description"></p>
           
        </div>
        <nav class="site-state motion-element">
          
            <div class="site-state-item site-state-posts">
              <a href="/archives">
                <span class="site-state-item-count">56</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-categories">
              
                <span class="site-state-item-count">29</span>
                <span class="site-state-item-name">分类</span>
              
            </div>
          

          
            
            
            <div class="site-state-item site-state-tags">
              
                <span class="site-state-item-count">29</span>
                <span class="site-state-item-name">标签</span>
              
            </div>
          

        </nav>
   
        
          <div class="feed-link motion-element">
            <a href="/atom.xml" rel="alternate">
              <i class="fa fa-rss"></i>
              RSS
            </a>
          </div>
        


        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/Suvan-L" target="_blank" title="GitHub"">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                  GitHub
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="mailto:liushuwei0925@gmail.com" target="_blank" title="Gmail"">
                  
                    <i class="fa fa-fw fa-envelope"></i>
                  
                  Gmail
                </a>
              </span>
            
          
        </div>

        
        

        
        

        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#目录"><span class="nav-text">目录</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-编写匿名块程序，实现根据商品名称进行模糊查询，输出该商品的其他基本信息"><span class="nav-text">1. 编写匿名块程序，实现根据商品名称进行模糊查询，输出该商品的其他基本信息</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-根据“双11促销活动”策略，编写一个匿名块程序，将原来折扣为0的，调整为0-9，将原来折扣为1的调整为0-95，其他的调整为0-92，之后输出“目前9折的商品有XX件，-92折的商品有XX件，-95折的商品有XX件”"><span class="nav-text">2. 根据“双11促销活动”策略，编写一个匿名块程序，将原来折扣为0的，调整为0.9，将原来折扣为1的调整为0.95，其他的调整为0.92，之后输出“目前9折的商品有XX件， 92折的商品有XX件， 95折的商品有XX件”</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-优化第1题，写成存储过程"><span class="nav-text">3. 优化第1题，写成存储过程</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-优化第2题-简单的方式解决"><span class="nav-text">4. 优化第2题,简单的方式解决</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-银行转账，将程序改造为存储过程"><span class="nav-text">5. 银行转账，将程序改造为存储过程</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-2-另一种版本"><span class="nav-text">5.2 另一种版本</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#6-审核采购表，编写存储过程"><span class="nav-text">6. 审核采购表，编写存储过程</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#7-编写根据订单单号审核订单的存储过程"><span class="nav-text">7. 编写根据订单单号审核订单的存储过程</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#8-计算税后工资"><span class="nav-text">8. 计算税后工资</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#9-自动生成采购单号（使用函数）"><span class="nav-text">9. 自动生成采购单号（使用函数）</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#10-使用函数实现订单编号的智能编码，规则为：用户Id-yyyymm-XXX-001-999"><span class="nav-text">10. 使用函数实现订单编号的智能编码，规则为：用户Id+yyyymm+XXX(001-999)</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#11-在添加订单明细时，用函数实现订单明细中根据商品编号返回商品的单价（商品信息表中）"><span class="nav-text">11. 在添加订单明细时，用函数实现订单明细中根据商品编号返回商品的单价（商品信息表中）</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#12-编写存储过程，实现订单的审核出库"><span class="nav-text">12. 编写存储过程，实现订单的审核出库</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#13-将上面10，11，12合成一个程序包"><span class="nav-text">13. 将上面10，11，12合成一个程序包</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#14-编写触发器，实现当订单明细发生改变时，调整订单总金额"><span class="nav-text">14. 编写触发器，实现当订单明细发生改变时，调整订单总金额</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#15-编写触发器，实现删除订单前，检查是否为2、发货中，3、已完结，如是提醒不能删除"><span class="nav-text">15. 编写触发器，实现删除订单前，检查是否为2、发货中，3、已完结，如是提醒不能删除</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#16-设计一个用于系统商品数据盘点的的表和存储过程"><span class="nav-text">16. 设计一个用于系统商品数据盘点的的表和存储过程</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#17-编写存储过程完成借书过程"><span class="nav-text">17. 编写存储过程完成借书过程</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#18-编写函数实现：借书记录号编码"><span class="nav-text">18. 编写函数实现：借书记录号编码</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#19-编写触发器-实现删除前判断"><span class="nav-text">19. 编写触发器,实现删除前判断</span></a></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script> <!--博客量统计-->
<div class="copyright" >
  
  &copy;  2016 - 
  <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Suvan</span>
</div>


<div class="powered-by">
   
  <!--
    由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
    -->
</div>

<div class="theme-info">
	能力决定走的多快，心态决定走的多远

  <!-- 主题
    主题 -
    <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
      NexT.Mist
    </a>
  -->
</div>


        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="https://cdn.bootcss.com/jquery/2.1.3/jquery.min.js"></script>

  
  <script type="text/javascript" src="https://cdn.bootcss.com/fastclick/1.0.6/fastclick.min.js"></script>

  
  <script type="text/javascript" src="https://cdn.bootcss.com/jquery_lazyload/1.9.7/jquery.lazyload.min.js"></script>

  
  <script type="text/javascript" src="https://cdn.bootcss.com/velocity/1.2.1/velocity.min.js"></script>

  
  <script type="text/javascript" src="https://cdn.bootcss.com/velocity/1.2.1/velocity.ui.min.js"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.1"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.1"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.1"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.1"></script>



  


  




	





  





  





  






  





  

  
<script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>


  

  

  
  <script type="text/javascript" src="/js/src/js.cookie.js?v=5.1.1"></script>
  <script type="text/javascript" src="/js/src/scroll-cookie.js?v=5.1.1"></script>


  

</body>
</html>
